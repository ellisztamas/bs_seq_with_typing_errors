%
% Paper title
% Authors
% 
%-----------------------------------------------------------------

\documentclass[12pt,longbibliography]{article}

% Packages
%-----------------------------------------------------------------

% Allow direct use of accents such as á é ñ.
\usepackage[utf8]{inputenc}

% This is a good idea to have some symbols included within the font
% properly:
% http://tex.stackexchange.com/questions/664/why-should-i-use-usepackaget1fontenc
\usepackage[T1]{fontenc}

% Set type of paper and margins.
\usepackage[a4paper, margin=2.7cm]{geometry}

\usepackage{amsmath, amsthm, amsfonts, amssymb}
\usepackage{mathrsfs}           % \mathscr font.

% Generate a PDF with hyperlinks in references.
\usepackage[colorlinks=true,linkcolor=blue,citecolor=blue,urlcolor=blue,breaklinks]{hyperref}

% Double-stroke font (\mathbbm).
\usepackage{bbm} 

\usepackage{graphicx}

% Bibliography
%-----------------------------------------------------------------

% This uses a bibliography style which hyperlinks the paper titles to
% the paper URL specified in the bibtex file. It also uses natbib,
% which cites papers by name such as Euler (1770) instead of [17].

\usepackage{breakurl}
\usepackage{natbib}
\usepackage{url}
% \bibliographystyle{plainnat-linked}
% \bibliographystyle{plain}
\usepackage[
          bibstyle=authortitle,
          citestyle=authoryear,
          maxbibnames=10,
          backend=biber
          ]{biblatex}
% \usepackage[style=authoryear]{biblatex}
% \usepackage{biblatex} %Imports biblatex package
\addbibresource{refs.bib} %Import the bibliography file


% Title, author, date
%-----------------------------------------------------------------

% If set, these will be the internal title and author of the PDF (and
% will be listed for example in ereaders and tablets).

% \hypersetup{pdftitle={Title of the PDF}}
% \hypersetup{pdfauthor={Author of the PDF}}


% Paper title and author
\title{Bisulphite sequencing in the presence of cytosine-conversion errors} % Article title

\author{
    Thomas James Ellis 
    \and
    Viktoria Nyzhynska
    \and
    Rahul Pisupati 
    \and
    Gr\'{e}goire Bohl-Viallefond
    \and
    Almudena Moll\'a Morales
    \and
    Magnus Nordborg
}



% Date is set automatically unless specified.
% \date{October 2015}

\date{\today} % Leave empty to omit a date

\begin{document}
\maketitle

\begin{abstract}
    Cytosine methylation is a common epigenetic mark, and is associated with silencing of transposable elements.
    Bisulphite treatment of DNA, leading to the conversion of unmethylated cytosines to thymine, is a common approach to infer the methylation status of cytosines.
    'Tagmentation' approaches to bisulphite treatment use a transposase to simultaneously make double-stranded breaks and ligate adaptors to the resulting fragments.
    This facilitates higher throughput of samples than is practical using traditional protocols that rely on sonication.
    However, it has also been noted that certain tagmentation protocols have an unusually high number unmethylated cytosines that are not converted to thymine.
    Here we describe this phenomenon in detail, and find that this is unlikely to be due to PCR or bioinformatic artefacts.
    We tentatively suggest that the issue is due to single strand nicks by the transposase, followed by strand displacement of part or all of the DNA fragments.
    Nevertheless we show that these errors can be accounted for in downstream analysis, and that for many applications they are sufficiently small not to affect biological conclusions.
    \end{abstract}



% \author[\centering AUTHOR]{
%     \so{Thomas James Ellis, Viktoria Nyzhynska, Rahul Pisupati, Gr\'{e}goire Bohl-Viallefond, Almudena Moll\`a Morales, Magnus Nordborg}
%     \thanks{Corresponding author.\hfil\break e-mail: magnus.nordborg@gmi.oeaw.ac.at}}
%     \affiliation{Gregor Mendel Institute of Molecular Plant Biology, Doktor-Bohr-Gasse 3, 1030 Vienna, Austria}


% \history{Manuscript received xx xxxx xx; in final form xx
% xxxx xx}

\maketitle

% \begin{keywords}
% methylation, bisulphite, transposase, tagmentation
% \end{keywords}

\section{Introduction}

Cytosine methylation is a common epigentic mark, and is often associated with transcriptional silencing.
A common approach to assay methylation is to treat DNA with sodium bisulphite, which converts unmethylated cytosines to uracil, that are then converted to thymine in a subsequeny PCR step (\cite{clark1994high}.
Methylated cytosines remain intact.
Following sequencing of the resulting DNA fragments reads are aligned to a reference genome.
The methylation status at each site is determined based on how many thymines and cytosines align to each genomic cytosine position.
This gives a quantitative estimate of the proportion of cells in which each cytosine is methylated.

A major limitation of bisulphite treatment is that the process itself damages DNA, meaning that large amounts of starting material are required for adequate results.
Early studies provided the first genome-wide surveys of methylation profiles, but relied on sonication of DNA followed by a delicate adaptor-ligation step (e.g. \cite{meissner2005reduced, cokus2008shotgun, lister2009human}).
Aiming to make the procedure more easily scalable to large samples, 'tagmentation' approaches use a Tn5 transposase to simultaneously cut the DNA and ligate adaptors and PCR primers to the fragments (\cite{wang2013tagmentation}).
In the original protocol, the transposase is loaded with a single adaptor, and the second adaptor is annealed by by oligo replacement, followed by repair of the nine-base-pair single-stranded gap left by the transposase (\cite{adey2012ultra}).
This allows for several orders of magnitude less starting material than sonication-based protocols, but the oligo-replacement step remains the most challenging step.
\textcite{lu2015improved} modified this approach to load the transposome with two methylated adaptors, and to replace the oligo-replacement and gap repair steps with a single strand displacement reaction by a \textit{Bst} polymerase which simultaneously fills the nine-base-pair gap and replacement of the adaptor sequence (see also \cite{weichenhan2018tagmentation, suzuki2018whole}).
In contrast to the previous approach, gap repair is carried out using dNTPs with 5-methyl-dCTPs instead of dCTPs.
Using two adaptors also has the advantage that the original and complementary strands generated by PCR can be distinguished by read-alignment software, effectively doubling coverage. 
The stand-displacement tagmentation protocol thus has the potential to yield more information from less starting material.

However, accurate inference of methylation states requires that unmethylated cytosines be reliably converted to thymine.
A standard quality-control step is to include unmethylated control DNA, and to estimate the conversion rate as the proportion of cytosines that come back as thymines.
\textcite{lu2015improved} and \textcite{suzuki2018whole} reported that 1-2\% of reads generated by a strand-displacement protocol appeared to be entirely unconverted.
\textcite{lu2015improved} hypothesise that this phenomenon is due to rare single-strand nicks in the 5` adaptors that serve as a start site for extension by the \textit{Bst} polymerase, leading to strand displacement over the whole fragment.
Because the protocol uses 5-methyl-dCTPs, this would cause the whole strand to become methylated.
\textcite{lu2015improved} and \textcite{suzuki2018whole} attempt to filter out suspicious reads, but do not discuss the issue further.
Therefore, we do not yet fully understand this issue, nor the extent to which this bias or obscure real methylation patterns.

Here we address this issue by providing a detailed description of non-conversion errors using strand-displacement-based tagmentation.
We first describe patterns of non-conversion within reads and across the genome.
We describe a statistical framework to account for non-conversion errors to quantify and classify real cytosine methylation.
We find that when errors are modelled appropriately they need not hinder the use of strand-displacement bisulphite-sequencing protocols to address biological questions about methylation.

\section{Results}

\subsection{Non-conversion affects all or part of a read}

\begin{figure}
    \includegraphics{figure1.eps}
    \caption{
        Cytosine non-conversion within and between reads on unmethylated DNA from \textit{A. thaliana}, the entire \textit{D. melanogaster} and Lambda phage. For \textit{A. thaliana}, data are shown for reads aligning to the first 75kb of chloroplast.
        (A) Overall cytosine non-conversion rates across for different ratios of Tn5 to DNA and number of PCR cycles performed.
        (B) The distribution of the proportion of unconverted cytosines across reads. For clarity, reads with no unconverted cytosines are not shown.
        (C) The probability of observing an unconverted cytosine across each read on the four strands generated by bisulphite libraries (OT=original top strand; OB=original bottom; CTOT=complementary to original top; CTOB=complementary to original bottom) averaged over libraries.
    }
    \label{fig:reads}

\end{figure}

We investigated how and where cytosine non-conversion errors occur in plant, fly and viral DNA.
We prepared bisulphite libraries for samples of the \textit{Arabidopsis thaliana} reference accession \textit{Columbia} (Col-0), \textit{Drosophila melanogaster} and the Lambda phage.
Plant chloroplasts, fruit flies and this virus lack cytosine methylation, so any unconverted cytosines we observe must be erroneous.
For Arabidopsis we focussed on the first half of the chloroplast, because the second half shows strong homology with one of the autosomes.
To identify possible technical artefacts we modified the strand-displacement protocol described by \textcite{weichenhan2018tagmentation} to use two concentrations of transposase, and either 13 or 15 PCR cycles.
Overall cytosine non-conversion rates were very high, ranging from a few percent up to more than 17\% (figure \ref{fig:reads}A).
There was substantial variation between libraries, but there was no consistent effect of species, transposase concentration or number of PCR cycles.
High non-conversion do not seem to be constrained to any species, and there is substantial stochasticity between samples.

To investigate the phenomenon further we examined the distribution of cytosines non-conversion within and between reads.
Reads containing at least one cytosine fell into three categores.
The majority of reads (mean=71\%) showed no unconverted cytosines at all.
Remaining reads were roughly evenly split between those where every cytosine on a read was unconverted, and those where a small proportion of cytosines were unconverted (figure \ref{fig:reads}B).
In the latter case, the peak matched the overall non-conversion rates (figure \ref{fig:reads}A).
This indicates that two distinct processes contribute to cytosines non-conversion.

We found that non-conversion errors were more likely to occur towards the 3` than the 5` end of the read (figure \ref{fig:reads}C).
This may be partly due to the general tendency of sequence quality to decline along a read.
However, this is unlikely to be the main cause in this case because Phred scores are consistently high across reads.
This pattern must be due to reads with only partial non-conversion, since fully unconverted reads would increase non-conversion uniformly across the whole read.

There is also some evidence that non-conversion errors depend on strand.
Bisulphite libraries typically distinguish between four strands: the original top and bottom strands (OT, OB), and the strands complementary to the original strands that are synthesised during PCR (complementary to original top (CTOT) and complementary to original bottom, (CTOB)).
In the Arabidopsis and Lambda phage samples there is a slight tendency for the top strands to have increased errors than the bottom strands, and for the complementary strands to have increased errors compared to the corresponding original strands.
In the Drosophila samples there also appears to be a periodicity in the probabilities of non-conversion every five bases on the OB and CTOB strands only.
The reasons for this potential strand specificity remain unclear.

In summary, these results indicate that non-conversion errors occur at high frequency in samples from diverse organisms. It appears that affected reads result from two distinct processes that generate completely and partially unconverted reads.

\subsection{Non-conversion errors vary across the genome}

\begin{figure}
    \includegraphics{figure2.eps}
    \caption{
        Variation in cytosine non-conversion across the first half of the chloroplast in four independent replicate library preparations of the Arabidopsis accession Col-0.
        (A) 150bp windows across the chloroplast.
        (B) Relationship between non-conversion and coverage per base.
        (C) Relationship between non-conversion and GC content.
    }
    \label{fig:uncertainty}
\end{figure}

Taking the average cytosine non-conversion rate on control DNA gives a point estimate of the genome-wide non-conversion rate, but this might mask variation in error rates between sites.
To investigate this we estimated non-conversion rates in 150bp windows across the Arabidopsis chloroplast.
We found as much as five-fold variation in cytosine non-conversion between windows with remarkable consistency between samples (figure \ref{fig:uncertainty}A).
One explanation for this is that there is much less data per window than for the whole chloroplast, so estimates at any individual window will have larger standard errors, inflating the variance between windows.
However, the observed variance between windows was 6.4-fold greater than between simulated draws from a binomial distribution using the observed coverage at each window as the number of trial and the global mean non-conversion rate as the mean (figure?).
Moreover, Spearman correlation coefficients ($\rho$) between replicates ranged from 0.71 to 0.84, showing that the pattern was remarkably consistent between technical replicates of the library preparation protocol.
This indicates that the variation in non-conversion across the chloroplast reflects something intrinsic about the DNA rather than stochastic variation.

What aspects of the DNA or data might explain this variation?
There was a weak negative correlation ($\rho$ between -0.29 and -0.10) between non-conversion and coverage at each window in three samples, with a weak positive correlation in the remaining sample ($\rho = 0.18$; figure \ref{fig:uncertainty}C).
Nevertheless, while very low coverage causes estimates to be noisy, the lowest coverage per cytosine in any window was 32.7x, so this cannot account for a large proportion of the variance.
There were also consistent positive correlations between non-conversion and GC content in each window across samples ($\rho$ between 0.43 and 0.55; figure \ref{fig:uncertainty}D).
Say something about what this means.
Add a conclusion sentence.

In summary, it appears that non-conversion errors vary between regions of the genome in a systematic way. Although the underlying reasons for this are unclear, this observation warrant caution in using a single point estimate to account for errors across the genome.

\subsection{Methylation estimates depend more on sample size than non-conversion errors}

\begin{figure}
    \includegraphics{figure3.eps}
    \caption{
        Estimates of mean methylation in simulated data using different estimates of the non-conversion error rate.
        Plots show the effect of combining data over 1, 10 or 100 loci with 200 cytosines each for increasing sequencing depth.
        True methylation is 0.15 for all loci.
        Error rates for each locus are drawn from a beta distribution with shape parameters $a=17$ and $b=220$.
        True methylation level is estimated using the true error rate for the simulation and when the error rate is estimated as the mean of the beta distribution.
        We also show mean methylation for data with zero non-conversion errors.
        (A) Distribution of estimated means across replicate 200 simulations.
        (B) Mean deviation from the true value across simulations.
        Note that points are offset along the x-axis for visual clarity.
    }
    \label{fig:simulations}
\end{figure}

Estimates of average methylation reflect a binomial sampling process of converted and unconverted cytosines.
We aim to estimate this mean with as little bias and sampling variance as possible.
Non-conversion of truly unmethylated cytosines will bias apparent methylation up and down respectively.
Likewise, incorrect conversion of truly methylated cytosines will bias methylation downwards.
In this study we focus on the former, but note that the latter process is distinctly plausible.
Since these errors are statistical rather than biological, we can account for them by allowing for the probabilities of errors in the binomial sampling process (see section \ref{sec:binomial-with-errors}).
Given a good estimate of error rates, it is straightforward adjust estimates to correct these biases.

However, this correction is complicated by two practical concerns that effectively increase sample variance.
First, as noted above, there seems to be substantial variation in error rates between windows of the chloroplast.
If we try to use the chloroplast to gauge error rates at the rest of the genome, this implies that there is substantial uncertainty around the error rate at any specific window.
This will tend to overestimate true methylation when the error rate is above the mean error rate, and vice versa.
Second, the binomial sampling process itself introduces uncertainty about true methylation level.
This is especially true when the number of 'binomial trials' is small, such as when only a small region of the genome is examined and/or when coverage is low.
Variation in error rates and sample size should be expected to hinder our ability to estimate mean methylation accurately.

We used simulations to investigate the practical significance of conversion errors and binomial sampling on estimates of mean methylation.
We simulated converted and unconverted read on transposable elements (TEs) of typical size with and without non-conversion errors, and attempt to recover true methylation levels.
We also summed reads across multiple loci, each with it's own error rate, to reflect summing over multiple TEs in the same region or family (e.g. \cite{sasaki2019common}).
Inaccuracy for data with no errors (red points in figure \ref{fig:simulations}) reflect variance due to binomial sampling only, and represent the best case scenario for given coverage and number of loci.
The simulations showed a drop in accuracy compared to these data when conversion errors are introduced but the error rate is known (green).
This additional error must reflect the additional binomial variance that arises from sampling from both truly methylated and unmethylated reads.
We found an additional drop in accuracy when the error rate is not known but is estimated (blue).
This demonstrates that both binomial sampling and uncertainty in the true error rate contribute to uncertainty in true methylation rate.

Despite this, the effect of error rates on accuracy was much smaller than the effect of increasing sample size.
The accuracy of estimated means increased dramatically with increased number of trials, either by increasing the number of loci or sequence coverage, including when data are simulated without errors (figure \ref{fig:simulations}).
This is not surprising in itself, but it is notable that a fairly simple correction for error rates can recover good estimates of mean methylation over thousands of cytosines using modest sequence coverage, even with relatively high non-conversion errors of 5-10\%.
This implies that the best way to ensure accurate estimates of methylation is to increase sample size, either by increasing sequencing depth or by summing over larger windows or homologous loci.
Since sequencing depth is typically limited by budgets, the latter option is likely the most practical.
This also makes biological sense.
For example, methylation TEs are often targetted and co-regulated by the same pathways, so it makes sense to examine them together.
Increasing the number of binomial trials is the surest path to accurate estimates of mean methylation, even when errors are common.

\subsection{Reliable imputation of methylation state}

Fig: Three panels showing calls on chloroplast, TEs and genes.

In some applications it makes more sense to classify a discrete methylation 'state', rather than quantify methylation level.
For example, it might often make more sense to classify a region as methylated or unmethylated, reflecting whether the region is targetted by silencing machinery or not.
To illustrate this we categorised methylation status of regions of the Arabidopsis genome based on a model of methylation homeostasis posited by \textcite{zhang2020natural}.
In plants, cytosines can be methlylated in all three sequence contexts (CG, CHG and CHH, where H is any nucleotide except G) maintained by multiple pathways (\cite{law2010establishing}).
Although much of the Arabidopsis genome is unmethylated, some genes display 'gene-body methylation' characterised by methylation of CG sites, whose origin and function is hotly debated (\cite{muyle2022gene}). 
Transposable elements are associated with methylation in all three of these contexts (\cite{cokus2008shotgun, lister2008highly}).
\textcite{zhang2020natural} describe a model of methylation homeostasis that posits a continuum from non-methylation (um) to gene-body-like methylation (gbm) to TE-like methylation (TEm).
Since these three states are likeley maintained by distinct biological pathways it makes sense to model them as distinct methylation states, and will often be easier to work with than potentially noisy, overdispersed quantitative data.

We categorised methylation status for bisulphite in the presence of substantial non-conversion errors in our Arabidopsis samples.
We apply a model that compares the evidence that the counts of observed (un)converted reads in the three sequence contexts are consistent with non-conversion errors only, or a mixture of errors and real cytosine methylation (see \ref{sec:meth-state}).
We used this model to call methylation state on (1) windows of the chloroplast, (2) coding genes, and (3) annotated transposable elements known to be actively regulated by the CMT2 and RdDM pathways (\cite{stroud2013comprehensive}).
These regions represent regions likely to be in the unmethylated, gene-body-methylated (at least partially; \cite{zhang2020natural}) and TE-like methylation states respectively.

Add results here
Count how often you get ambiguous calls
Does it make a difference if we do hard calls or not?

This has the advantage that we need only know $a_{\lambda1}$ and $b_{\lambda2}$, and should be sufficient to distinguish 'low' and 'high' methylation as long as true methylation is not very close to the non-conversion error rate.
However, if prior information about the distribution of true methylation level is available, this can easily be incorporated with a suitable paramterisation of $g(.)$.

\section{Discussion}


What could explain this?
Reads not being trimmed correctly, or poor conversion.
We address this, but it's unlikely because these are the same between protocols
More likely to be to do with the strand displacement/gap repair step, which differ between protocols
dNTPS with mC are being incorporated, for example via repair of single-strand nicks.
PCR bias?

Discuss \cite{lu2015improved} and \cite{suzuki2018whole}'s solution's to the problem

Discuss Gaut's CG shenanigans

For calling methylation status there is potential to use other distributions.

\section{Materials and Methods}

\subsection{Biological material}

\subsection{Statistical models to accounts for conversion errors}

\subsubsection{Error rates in a binomial model} \label{sec:binomial-with-errors}

Given an alignment of bisulphite-converted reads to a genome we observe a total of $n$ reads mapping to genomics cytosines within a given region. Of these, $y$ reads are observed to be unconverted cytosines and $n-y$ reads appear as converted thymines. The goal is to estimate the true mean methylation level $\theta$ which generated these data, accounting for conversion errors.

In the absence of errors, the likelihood of the data given $\theta$ is binomially distributed as
\begin{equation}
    \label{eqn:classic-binomial}
    \Pr(y| \theta) = {n \choose y} \theta^y(1-\theta)^{n-y}
\end{equation}
with mean $\theta=y/n$.
Data are not perfect, so we would like to incorporate two error terms:
\begin{itemize}
    \item $\lambda_1$ is the probability that an unmethylated cytosine appears methylated (the bisulphite non-conversion rate).
    \item $\lambda_2$ is the probability that a methylated cytosine appears unmethylated, which we include for completeness.
\end{itemize}
Reads observed as cytosines may thus be either truly methylated with probability $\theta(1-\lambda_2)$ or truly unmethylated with probability $(1-\theta)\lambda_1$. Likewise, reads observed as thymine may be either truly unmethylated with probability $(1-\theta)(1-\lambda_1)$ or truly methylated with probability $\theta \lambda_2$.
This changes the likelihood to
\begin{equation}
    \label{eqn:binom-with-errors}
    \Pr(y | \theta, \lambda_1, \lambda_2) = 
    {n \choose y}
    [\theta(1-\lambda_2) + (1-\theta)\lambda_1]^y
    [\theta \lambda_2 + (1-\theta)(1-\lambda_1)]^{n-y}
\end{equation}
Summarising $p=[\theta(1-\lambda_2) + (1-\theta)\lambda_1] = y/n$ for brevity, this has a closed-form maximum-likelihood estimate
\begin{equation}
    \label{eqn:ml-theta}
    \hat{\theta} = \frac{\lambda_1-p}{\lambda_1 + \lambda_2 -1}
\end{equation}
Note that $\hat{\theta}<0$ when $\lambda_1 > \theta$ and $\hat{\theta}>1$ when $\lambda_2 > (1-\theta)$, which are not valid results
In these cases we set $\hat{\theta}$ to zero and one respectively.

\subsubsection{Error rates as a beta distribution} \label{sec:mean-as-beta}

The above formulation is valid for the case where there is a clear point estimate for error rates.
If there is substantial uncertainty around these estimates, and especially if they are likely to vary across the genomes, then error rates can be modelled as coming from beta distributions with shape parameters $a$ and $b$.
These shape parameters can be estimated by method-of-moments using estimates of the sample mean $\mu$ and variance $\sigma$ of the distribution.
For example, one can calculate mena and variance in the proportion of unconverted cytosines across windows of DNA known to be unmethylated.
Estimates for shape parameters are then:
\begin{equation}
    \hat{a} = \mu(\frac{\mu(1-\mu)}{\sigma^2}-1)
    \label{eqn:beta-a}
\end{equation}
\begin{equation}
    \hat{b} = (1-\mu)(\frac{\mu(1-\mu)}{\sigma^2}-1) 
    \label{eqn:beta-b}
\end{equation}

% $$ \theta \sim \textrm{Beta}(a_{\theta}, b_{\theta}) $$
% $$ \lambda_1 \sim \textrm{Beta}(a_{\lambda_1}, b_{\lambda_1}) $$
% $$ \lambda_2 \sim \textrm{Beta}(a_{\lambda_2}, b_{\lambda_2}) $$
% The distributions over $\theta$, $\lambda_1$ and $\lambda_2$ represent prior distributions of $\theta$ and error rates, and can be estimated from other data.
% For example, $\lambda_1$ can be estimated by counting the proportion of all unconverted cytosines in windows of DNA that is known to be unmethylated to get a distribution of error rates, and taking mean $\bar{x}$ and variance $\sigma^2_x$ of these estimates.
% The shape parameters of the Beta distribution for $\lambda_1$ can be calculated by method-of-moments as
% \begin{equation}
%     \hat{a}_{\lambda_1} = \bar{x}(\frac{\bar{x}(1-\bar{x})}{\sigma^2_x}-1)
%     \label{eqn:beta-a}
% \end{equation}
% \begin{equation}
%     \hat{b}_{\lambda_1} = (1-\bar{x})(\frac{\bar{x}(1-\bar{x})}{\sigma^2_x}-1) 
%     \label{eqn:beta-b}
% \end{equation}

% We can use this information to estimate $\theta$ by integrating out values for error rates.
% The joint posterior distribution of $\theta, \lambda_1, \lambda_2$ is then
% \begin{equation}
%     \Pr(\theta, \lambda_1, \lambda_2 | y, \pi)
%     \propto 
%     \Pr(y | \theta, \lambda_1, \lambda_2)
%     \Pr(\theta | a_{\theta}, b_{\theta})
%     \Pr(\lambda_1 | a_{\lambda_1}, b_{\lambda_1})
%     \Pr(\lambda_2 | a_{\lambda_2}, b_{\lambda_2})
% \end{equation}
% where $\pi=\{a_{\theta}, a_{\lambda_1}, a_{\lambda_2}, b_{\theta}, b_{\lambda_1}, b_{\lambda_2}\}$ for brevity.
% The marginal posterior distribution for $\theta$ can be found by integrating over $\Pr(\lambda_1)$ and $\Pr(\lambda_2)$.
% This can be simplified if we assume $\lambda_2$ is negligible and modify  equation \ref{eqn:ml-theta} to estimate $\theta$ directly, in which case the expected value for $\theta$ is
% \begin{equation}
%     \hat{\theta} = 
%     \int_0^1 
%     \frac{\lambda_1 - p} {\lambda_1 - 1}
%     \Pr(\theta | \lambda_1) \,d\lambda_1
%     \label{eqn:theta-with-uncertainty}
% \end{equation}

\subsubsection{Classification of methylation state} \label{sec:meth-state}

In some cases it makes biological sense to classify the 'state' of a region as methylated or unmethylated rather than quantify methylation level.
If we assume false conversion errors ($\lambda2$) are negligible, this can be achieved by comparing the evidence that the proportion of unconverted cytosines $p$ is drawn from distribution $f(.)$ generating false non-conversion errors, or from an alternative distribution $g(.)$ that reflects real biological processes.

$f(.)$ can be modelled as a the compound of a binomial and beta distribution using shape parameters:
\begin{equation}
    f(p,a_{\lambda1}, b_{\lambda2}) = 
    \textrm{Bin}(y|n,p)
    \textrm{Beta}(p | a_{\lambda1}, b_{\lambda2})
\end{equation}
where $a, b$ are shape parameters of the beta distribution of error rates (section \ref{sec:mean-as-beta}).
We model $g(.)$ using the cumulative density function of the same beta distribution:
\begin{equation}
    g(p,a_{\lambda1}, b_{\lambda2}) = 
    \textrm{Bin}(y|n,p)
    \Pr( P \leq p | a_{\lambda1}, b_{\lambda2})
\end{equation}
which approaches zero when the proportion of unconverted reads is small, and approaches one when the number of unconverted reads is more than can be accounted for by $ f(p,a_{\lambda1}, b_{\lambda2}) $.
Both terms incorporate the binomial probability of observing the number of unconverted reads given estimated mean and samples size.
This formulation asks whether mean methylation is compatible with errors alone, or with something greater than that.

We can apply this model to quantify the evidence that a region of DNA is unmethylated (um), gene-body-like methylated (gbm) or TE-like methylated (TEm) based on the observed non-converted reads in the CG, CHG and CHH sequence contexts ($y_{CG}$, $y_{CHG}$ and $y_{CHH}$; H is any nucleotide apart from G).
In unmethylated DNA all unconverted cytosines are due to non-conversion errors, and hence the likelihood that the region is unmethylated is
\begin{equation}
    L_U =
    f(y_{CG}  | n_{CG},  a_{\lambda1}, b_{\lambda2})
    f(y_{CHG} | n_{CHG}, a_{\lambda1}, b_{\lambda2})
    f(y_{CHH} | n_{CHH}, a_{\lambda1}, b_{\lambda2})
\end{equation}
In gene-body-like-methylated DNA, CG sites are methylated but CHG and CHH sites are not: 
\begin{equation}
    L_{gbm} =
    g(y_{CG}  | n_{CG},  a_{\lambda1}, b_{\lambda2})
    f(y_{CHG} | n_{CHG}, a_{\lambda1}, b_{\lambda2})
    f(y_{CHH} | n_{CHH}, a_{\lambda1}, b_{\lambda2})
\end{equation}
In TE-like-methylated DNA cytosines are methylated in all contexts:
\begin{equation}
    L_{TEm} =
    g(y_{CG}  | n_{CG},  a_{\lambda1}, b_{\lambda2})
    g(y_{CHG} | n_{CHG}, a_{\lambda1}, b_{\lambda2})
    g(y_{CHH} | n_{CHH}, a_{\lambda1}, b_{\lambda2})
\end{equation}

\subsection{Simulations}

We used simulations to investigate how well we can estimate true mean methylation when observed data are contaminated with non-conversion errors.
We simulated loci of 800 nucleotides (200 cytosines), corresponding to the average size (798bp) of a transposable element or TE fragment in the \textit{A. thaliana} TAIR10 annotation, with 1, 2, 4, 8, 16 or 32 reads mapping to each cytosine.
We simulated the conversion state of each read at each cytosine as a binomial process with the total number of trials being the number of cytosines multiplied by coverage per cytosine.
Following equation \ref{eqn:binom-with-errors} and ignoring false conversion errors, each read may be observed as unconverted with probability $p=\theta + (1-\theta)\lambda_1$, where $\theta$ is the probability that the read is truly methylated and $\lambda1$ is a non-conversion error rate.
We used $\theta=0.15$ for these simulations, which is both a realistic estimate of TE methylation level (\cite{dubin2015dna}) and close enough to true error rates that the latter are likely to be problematic.

For each locus we drew a value for $\lambda_!$ from a beta distribution describing variation in error rates across the genome (see section \ref{sec:mean-as-beta}).
To estimate biologically realistic shape parameters for this distribution we estimated the mean and variation in non-conversion rates in 150bp windows across the chloroplast for one of the Arabidopsis samples, and calculated beta shape parameters by method of moments (equations \ref{eqn:beta-a}, \ref{eqn:beta-b}). 


We simulated loci of 200 cytosines, corresponding to TEs of 800bp; the average length of TEs and TE fragments in the Arabidopsis TAIR10 assembly is 798bp.
Mean methylation of 0.15, because this is realistic for TEs and fairly close to the error distribution.
At each locus we drew and error rate from a Beta
We also summed loci
This gives biologically realistic data


\section{Ackowledgements}

We thank Robert Schmitz, Dieter Weichenhan and members of the Nordborg group for discussion of the results.
We specifically thank Yoav Voichek for technical assistance on how to disembowel SAM files.

\printbibliography %Prints bibliography

\end{document}